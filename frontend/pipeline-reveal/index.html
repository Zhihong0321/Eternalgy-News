<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pipeline Reveal | Eternalgy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" defer></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-8 space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <p class="text-xs uppercase tracking-[0.4em] text-emerald-300">Pipeline Reveal</p>
        <h1 class="text-2xl font-semibold">Inspect search → Reader → Rewriter</h1>
      </div>
      <a href="/" class="text-sm text-emerald-300 underline">Back to feed</a>
    </header>

    <!-- Sticky error/log panel -->
    <div id="error-panel" class="hidden bg-rose-900/30 border border-rose-700 rounded-2xl px-4 py-3 text-sm text-rose-100 whitespace-pre-wrap"></div>

    <!-- Search -->
    <section class="bg-slate-900/70 border border-slate-800 rounded-3xl p-5 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">1) Search</h2>
        <button id="run-search" class="px-4 py-2 rounded-xl bg-emerald-500 text-slate-900 font-semibold text-sm hover:bg-emerald-400">Run search</button>
      </div>
      <textarea id="search-prompt" rows="3" class="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-400 outline-none" placeholder="User intent, e.g. 'Latest Malaysia solar PV news Jan-Mar 2025'"></textarea>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-500 mb-1">Wrapped prompt</p>
          <pre id="search-wrapped" class="bg-slate-950/60 border border-slate-800 rounded-xl p-3 text-xs whitespace-pre-wrap"></pre>
        </div>
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-500 mb-1">Parsed URLs</p>
          <div id="search-results" class="space-y-1 text-sm"></div>
        </div>
      </div>
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-slate-500 mb-1">Raw response</p>
        <textarea id="search-raw" rows="6" class="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2 text-xs"></textarea>
      </div>
    </section>

    <!-- Reader -->
    <section class="bg-slate-900/70 border border-slate-800 rounded-3xl p-5 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">2) Reader (GPT-5 search)</h2>
        <button id="run-jina" class="px-4 py-2 rounded-xl bg-emerald-500 text-slate-900 font-semibold text-sm hover:bg-emerald-400">Fetch article</button>
      </div>
      <input id="jina-url" class="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-400 outline-none" placeholder="Pick a URL from search results or paste one" />
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-500 mb-1">Parsed</p>
          <pre id="jina-parsed" class="bg-slate-950/60 border border-slate-800 rounded-xl p-3 text-xs whitespace-pre-wrap"></pre>
        </div>
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-500 mb-1">Raw</p>
          <textarea id="jina-raw" rows="8" class="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2 text-xs"></textarea>
        </div>
      </div>
    </section>

    <!-- Rewriter -->
    <section class="bg-slate-900/70 border border-slate-800 rounded-3xl p-5 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">3) Rewriter</h2>
        <button id="run-rewrite" class="px-4 py-2 rounded-xl bg-emerald-500 text-slate-900 font-semibold text-sm hover:bg-emerald-400">Rewrite</button>
      </div>
      <div class="grid md:grid-cols-2 gap-3">
        <div class="space-y-2">
          <input id="rw-title" class="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2 text-sm" placeholder="Title from reader" />
          <input id="rw-date" class="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2 text-sm" placeholder="Date (optional)" />
          <input id="rw-url" class="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2 text-sm" placeholder="URL" />
          <textarea id="rw-content" rows="6" class="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2 text-sm" placeholder="Content from reader"></textarea>
        </div>
        <div class="space-y-2">
          <input id="rw-model" class="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2 text-sm" placeholder="Rewriter model, e.g. openai/gpt-oss-20b:free" />
          <textarea id="rw-prompt" rows="8" class="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2 text-sm" placeholder="Rewriter prompt (placeholders {title},{date},{url},{content})"></textarea>
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-500 mb-1">Parsed JSON</p>
          <pre id="rw-parsed" class="bg-slate-950/60 border border-slate-800 rounded-xl p-3 text-xs whitespace-pre-wrap"></pre>
        </div>
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-500 mb-1">Raw text</p>
          <textarea id="rw-raw" rows="8" class="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2 text-xs"></textarea>
        </div>
      </div>
    </section>

    <div id="toast" class="hidden fixed bottom-6 right-6 px-4 py-3 rounded-xl text-sm font-semibold"></div>
  </div>

  <script>
    const runSearchBtn = document.getElementById("run-search");
    const runJinaBtn = document.getElementById("run-jina");
    const runRewriteBtn = document.getElementById("run-rewrite");
    const toast = document.getElementById("toast");
    const errorPanel = document.getElementById("error-panel");
    function setLoading(btn, isLoading, loadingText = "Working...") {
      if (!btn) return;
      if (!btn.dataset.label) btn.dataset.label = btn.textContent;
      btn.disabled = isLoading;
      btn.textContent = isLoading ? loadingText : btn.dataset.label;
      btn.classList.toggle("opacity-60", isLoading);
      btn.classList.toggle("cursor-not-allowed", isLoading);
    }

    function showToast(msg, variant = "success") {
      toast.textContent = msg;
      toast.className = `fixed bottom-6 right-6 px-4 py-3 rounded-xl text-sm font-semibold ${variant === "success" ? "bg-emerald-500 text-slate-900" : "bg-rose-500 text-white"}`;
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 3000);
    }
    function showErrorPanel(msg) {
      if (!msg) {
        errorPanel.classList.add("hidden");
        errorPanel.textContent = "";
        return;
      }
      errorPanel.textContent = msg;
      errorPanel.classList.remove("hidden");
    }

    const searchPrompt = document.getElementById("search-prompt");
    const searchWrapped = document.getElementById("search-wrapped");
    const searchRaw = document.getElementById("search-raw");
    const searchResults = document.getElementById("search-results");
    function buildWrappedPrompt(intent) {
      return `You are a news URL selector. Based on the user intent, return ONLY a JSON array (no Markdown/code fences/text) of up to 10 objects:
[{"url": "https://...", "title": "Story title"}]
Rules:
- Output must be valid JSON: an array of objects with keys "url" and "title" only.
- Strip tracking params; use canonical article URLs when possible.
- Deduplicate URLs; prefer recent, source-matched results.
- Exclude social media, video shorts, ads, nav pages, or homepages.
- Do not include explanations or any text before/after the JSON array.

User intent: ${intent}`.trim();
    }
    runSearchBtn.addEventListener("click", async () => {
      searchWrapped.textContent = "";
      searchRaw.value = "";
      searchResults.innerHTML = "";
      showErrorPanel("");
      setLoading(runSearchBtn, true, "Running...");
      try {
        const intent = searchPrompt.value || "";
        const wrappedLocal = buildWrappedPrompt(intent);
        searchWrapped.textContent = wrappedLocal;
        const res = await fetch("/api/pipeline/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: intent })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || "Search failed");
        searchWrapped.textContent = data.wrapped_prompt || wrappedLocal;
        searchRaw.value = data.raw || "";
        (data.parsed || []).forEach(item => {
          const btn = document.createElement("button");
          btn.className = "block w-full text-left px-3 py-2 rounded-lg bg-slate-800/80 hover:bg-slate-700 text-sm";
          btn.textContent = `${item.title || item.url}`;
          btn.onclick = () => {
            document.getElementById("jina-url").value = item.url;
          };
          searchResults.appendChild(btn);
        });
        showToast("Search done");
      } catch (e) {
        console.error(e);
        showErrorPanel(e.message);
        showToast("Error (see error panel)", "error");
      } finally {
        setLoading(runSearchBtn, false);
      }
    });

    const jinaUrl = document.getElementById("jina-url");
    const jinaParsed = document.getElementById("jina-parsed");
    const jinaRaw = document.getElementById("jina-raw");
    runJinaBtn.addEventListener("click", async () => {
      jinaParsed.textContent = "";
      jinaRaw.value = "";
      showErrorPanel("");
      setLoading(runJinaBtn, true, "Fetching...");
      try {
        const res = await fetch("/api/pipeline/jina", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url: jinaUrl.value || "" })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || "Reader failed");
        jinaParsed.textContent = JSON.stringify(data.parsed, null, 2);
        jinaRaw.value = JSON.stringify(data.parsed, null, 2);
        // Autofill rewriter fields
        document.getElementById("rw-title").value = data.parsed?.title || "";
        document.getElementById("rw-url").value = data.parsed?.url || jinaUrl.value;
        document.getElementById("rw-content").value = data.parsed?.content || "";
        showToast("Reader done");
      } catch (e) {
        console.error(e);
        showErrorPanel(e.message);
        showToast("Error (see error panel)", "error");
      } finally {
        setLoading(runJinaBtn, false);
      }
    });

    const rwParsed = document.getElementById("rw-parsed");
    const rwRaw = document.getElementById("rw-raw");
    const rwPromptInput = document.getElementById("rw-prompt");
    const rwModelInput = document.getElementById("rw-model");
    const defaultRewritePrompt = `==== Prompt for NEWS Rewriter AI =======

You are an expert News Analyst, Multilingual Content Specialist, and the lead editor shaping copy for our live dashboard. Rewrite each story as a production-ready brief in first-person voice, reporting the facts directly without saying "the article" or "this story." Everything you deliver must stay within the JSON structure shown below and follow all extraction, formatting, and translation rules.

[b]--- INPUT DATA ---[/b]
[b]Article Title:[/b] {title}
[b]Article Date:[/b] {date}
[b]Source URL:[/b] {url}
[b]Raw Content (JINA AI Scrape):[/b]
{content}

[b]--- PROCESSING & OUTPUT RULES ---[/b]
1. Extract ONLY info related to the Article Title; drop boilerplate/ads/nav.
2. Summarize key facts into bullet points for \`news content (en)\` in first-person voice.
3. Generate concise headlines for \`title_en\`, \`title_zh\`, and \`title_ms\` (no BBcode/bullets).
4. Translate the English bullets into Simplified Chinese and Bahasa Melayu (no BBcode).
5. Pick exactly 3 tags from: solar, wind, battery, policy, malaysia, asean, china, us, euro, renewable.
6. No emojis. Output a single valid JSON object:
{{
  "title_en": "Headline",
  "title_zh": "Chinese headline",
  "title_ms": "Malay headline",
  "news date": "{date}",
  "news source url": "{url}",
  "news content (en)": "- bullet...",
  "news content (zh-cn)": "- bullet...",
  "news content (my)": "- bullet...",
  "tags (pick 3)": ["tag1","tag2","tag3"]
}}
===============================
Your output is passed to the next stage, so follow all rules strictly.`;

    rwPromptInput.value = defaultRewritePrompt;

    document.getElementById("run-rewrite").addEventListener("click", async () => {
      rwParsed.textContent = "";
      rwRaw.value = "";
      showErrorPanel("");
      setLoading(runRewriteBtn, true, "Rewriting...");
      try {
        const res = await fetch("/api/pipeline/rewrite", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: document.getElementById("rw-title").value || "",
            date: document.getElementById("rw-date").value || "",
            url: document.getElementById("rw-url").value || "",
            content: document.getElementById("rw-content").value || "",
            prompt: rwPromptInput.value || "",
            model: rwModelInput.value || ""
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || "Rewrite failed");
        rwParsed.textContent = data.parsed ? JSON.stringify(data.parsed, null, 2) : (data.error || "No parsed JSON");
        rwRaw.value = data.raw_text || "";
        showToast("Rewrite done");
      } catch (e) {
        console.error(e);
        showErrorPanel(e.message);
        showToast("Error (see error panel)", "error");
      } finally {
        setLoading(runRewriteBtn, false);
      }
    });

    async function loadRewriterDefaults() {
      try {
        const res = await fetch("/api/rewriter/prompt");
        const data = await res.json();
        if (res.ok) {
          rwPromptInput.value = data.prompt || defaultRewritePrompt;
          rwModelInput.value = data.model || "";
        } else {
          showErrorPanel(`Prompt load failed; using fallback. ${data.detail || ""}`.trim());
        }
      } catch (e) {
        console.error("Failed to load rewriter defaults", e);
        showErrorPanel("Prompt load failed; using fallback prompt.");
        rwPromptInput.value = defaultRewritePrompt;
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      if (window.lucide) window.lucide.createIcons();
      loadRewriterDefaults();
    });
  </script>
</body>
</html>
